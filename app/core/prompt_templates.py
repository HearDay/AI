"""
레벨별(초급/중급/심화) 탐구형 질문 템플릿 + 자연스러운 대화 톤 지침.
- beginner : 사실 이해
- intermediate : 원인/영향
- advanced : 대안/가치판단
"""

# ------------------------------------------------------------
# 레벨별 가이드라인 정의
# ------------------------------------------------------------
LEVEL_GUIDES = {
    "beginner": """[레벨 가이드]
- 사실 이해 중심(누가, 언제, 어디서, 무엇을)
- 문장은 짧고 명료하게
- 판단을 보류하고 중립적으로 표현
""",
    "intermediate": """[레벨 가이드]
- 원인/영향 중심(왜, 누구에게 어떤 영향)
- 단기/장기 관점 구분
- 반례를 조심스럽게 제시
""",
    "advanced": """[레벨 가이드]
- 대안/가치판단 중심(해결책, 원칙, 트레이드오프)
- 수용 가능한 타협안과 리스크 제시
- 필요하다고 판단되는 경우에만 근거 유형(통계, 전문가 의견, 사례 등)을 선택적으로 사용할 수 있음

"""
}

# ------------------------------------------------------------
# 대화 톤 지침
# ------------------------------------------------------------
CONVERSATIONAL_STYLE = """[대화 톤 지침]
- 사람처럼 자연스럽게, 과장·명령조 금지.
- 간단한 추임새 허용: "음,", "그럴 수도 있겠네요.", "좋은 생각이에요."
- 1~2문장 단락, 공손하고 중립적인 어조 유지.
- 문장은 질문 또는 대화로 끝나도록 한다.
"""

# ------------------------------------------------------------
# 숫자형 레벨 매핑 함수
# ------------------------------------------------------------
def map_level_to_category(level: int) -> str:
    """숫자형 레벨(1~6)을 문자열 카테고리(beginner/intermediate/advanced)로 변환"""
    if level in [1, 2]:
        return "beginner"
    elif level in [3, 4]:
        return "intermediate"
    elif level in [5, 6]:
        return "advanced"
    else:
        return "beginner"

# ------------------------------------------------------------
# 탐구형 질문 프롬프트 생성 함수
# ------------------------------------------------------------
from typing import Union

def build_open_question_prompt(summary: str, level: Union[int, str] = "beginner") -> str:
    """뉴스 요약문을 받아 레벨별 탐구형 질문을 한 문장으로 생성"""
    if isinstance(level, int):
        lvl = map_level_to_category(level)
    else:
        lvl = (level or "beginner").lower()

    guide = LEVEL_GUIDES.get(lvl, LEVEL_GUIDES["beginner"])

    return f"""너는 사용자의 뉴스 이해를 돕는 대화형 토론 파트너이자 질문 설계자다.
- 먼저 뉴스 내용을 바탕으로 자연스러운 짧은 피드백을 한 문장 생성하고,
- 이어 탐구형 질문을 한 문장 덧붙여라.

{CONVERSATIONAL_STYLE}
{guide}

[작업]
- 아래 뉴스 요약을 읽고, 사용자와 대화하듯 한~두 문장의 개방형 탐구 질문을 만들어라.
- '~어떨까요?', '~보시나요?', '~생각하시나요?' 같은 부드러운 형태 허용.
- 유도·편향 금지, 초보 사용자도 이해할 수 있는 표현 사용.
- 문체는 항상 공손한 존댓말로 표현한다.
- 반말, 명령조, 친구 말투는 절대 사용하지 않는다.

[뉴스 요약]
{summary.strip()}
"""

# ------------------------------------------------------------
# 대화체 후처리 함수
# ------------------------------------------------------------
def conversational_rewrite(text: str) -> str:
    """모델이 딱딱한 어투로 답했을 때 자연스럽게 다듬기"""
    text = (
        text.replace("해야 한다", "하면 좋겠습니다")
            .replace("하라", "해 볼까요")
            .replace("하십시오", "해 볼까요")
            .replace("것이다", "것 같아요")
            .replace("입니다.", "인 것 같아요.")
            .replace("라고 생각합니다", "라고 볼 수도 있겠네요")
    )
    lines = [l.strip(" -•") for l in text.splitlines() if l.strip()]
    return " ".join(lines)
